apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: global-exit-hook
spec:
  entrypoint: global-exit-hook
  templates:
    - name: global-exit-hook
      container:
        # Pulled May 30, 2025
        image: alpine@sha256:a8560b36e8b8210634f77d9f7f9efd7ffa463e380b75e2e74aff4511df3ef88c
        env:
          - name: SLACK_WEBHOOK_URL_B64
            value: "~vault:Projects/k8s/argo-workflows:slack_notifications_url~"
          - name: STATUS
            value: '{{ "{{workflow.status}}" }}'
          - name: FAILURES
            value: '{{ "{{workflow.failures}}" }}'
          - name: NAME
            value: '{{ "{{workflow.name}}" }}'
          - name: NAMESPACE
            value: '{{ "{{workflow.namespace}}" }}'
          - name: MAIN_ENTRYPOINT
            value: '{{ "{{workflow.mainEntryPoint}}" }}'
          - name: DURATION
            value: '{{ "{{workflow.duration}}" }}'
          - name: CREATION_TIMESTAMP
            value: '{{ "{{workflow.creationTimestamp}}" }}'
          - name: LABELS
            value: '{{ "{{workflow.labels.json}}" }}'
          - name: ANNOTATIONS
            value: '{{ "{{workflow.annotations.json}}" }}'
          - name: PARAMETERS
            value: '{{ "{{workflow.parameters.json}}" }}'
        command:
          - sh
          - -c
          - |
            set -euo pipefail
            wget -q -O - \
              --post-data "payload={\"channel\":\"argo-workflows-notifications\",\"username\":\"argo\",\"text\": \"Workflow *$NAME* in namespace *$NAMESPACE* has finished with status *$STATUS* after $DURATION seconds.\\nMain entrypoint: $MAIN_ENTRYPOINT\\nCreation timestamp: $CREATION_TIMESTAMP\\nLabels: $LABELS\\nAnnotations: $ANNOTATIONS\\nParameters: $PARAMETERS\\nFailures: $FAILURES\"}" \
              $(echo $SLACK_WEBHOOK_URL | base64 -d)
