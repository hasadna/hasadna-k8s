apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: runner
spec:
  arguments:
    parameters:
      - name: exec_script
        default: "ceph status"
  entrypoint: dag
  templates:
    - name: dag
      dag:
        tasks:
          - name: script
            template: script
            arguments:
              parameters:
                - name: exec_script
                  value: |
                    {{ "{{workflow.parameters.exec_script}}" }}
    - name: script
      serviceAccountName: workflow-runner
      inputs:
        parameters:
          - name: exec_script
      volumes: {{ include "runner.volumes" . | nindent 8 }}
      script: {{ include "runner.podSpec" . | nindent 8 }}
        source: |
          set -euo pipefail
          (
            mkdir -p /etc/ceph
            echo "[global]
          mon_host = rook-ceph-mon-a:6789,rook-ceph-mon-b:6789,rook-ceph-mon-c:6789

          [client.admin]
          keyring = /etc/ceph/keyring" > /etc/ceph/ceph.conf
            echo "[${ROOK_CEPH_USERNAME}]
          key = ${ROOK_CEPH_KEYRING}" > /etc/ceph/keyring
            kopia repository connect s3 --bucket=$KOPIA_S3_BUCKET --region=$KOPIA_S3_REGION
          ) 2>&1 | tee /tmp/log.txt
          cat <<'EOF' > /tmp/exec_script.sh
          {{ "{{inputs.parameters.exec_script}}" }}
          EOF
          chmod +x /tmp/exec_script.sh
          /tmp/exec_script.sh 2>&1 | tee /tmp/log.txt
          echo "Execution completed successfully" 2>&1 | tee /tmp/log.txt
      outputs:
        parameters:
          - name: log
            valueFrom:
              path: /tmp/log.txt
