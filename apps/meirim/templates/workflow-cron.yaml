{{- range $task := .Values.cronWorkflows }}
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ $task.name | quote }}
spec:
  entrypoint: task
  synchronization:
    semaphore:
      configMapKeyRef:
        name: argo-workflows
        key: tasks-concurrency
  templates:
    - name: task
      steps:
        - - name: call-template
            templateRef:
              name: task-runner
              template: task-runner
            arguments:
              parameters:
                - name: command
                  value: {{ $task.command | quote }}
                - name: coralogixServiceName
                  value: {{ $task.coralogixServiceName | quote }}
---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: {{ $task.name | quote }}
spec:
  schedule: {{ $task.schedule | quote }}
  concurrencyPolicy: Forbid
  workflowSpec:
    workflowTemplateRef:
      name: {{ $task.name | quote }}
---
{{- end }}

{{ if false }}
# TODO: add the following cron workflows:
#
# bin_fetch_tree_permit
#   Cron expression
#20 8,20 ? * 1-5 *
# {
#  "containerOverrides": [{
#    "name": "meirim",
#    "command": [
#      "bin/fetch_tree_permit"
#    ],
#    "environment": [{
#      "name": "SERVER_CORALOGIX_SERVICE_NAME",
#      "value": "fetch_tree_permit"
#    }]
#  }]
#}

# bin_iplan
# Cron expression
#0 8-20 ? * 1-5 *
# {
#  "containerOverrides": [{
#    "name": "meirim",
#    "command": [
#      "bin/iplan"
#    ],
#    "environment": [{
#      "name": "SERVER_CORALOGIX_SERVICE_NAME",
#      "value": "iplan"
#    }]
#  }]
#}

# bin_send_emails
# Cron expression
# 0 * ? * 1-5 *
# {
#  "containerOverrides": [{
#    "name": "meirim",
#    "command": [
#      "bin/send_emails"
#    ],
#    "environment": [{
#      "name": "SERVER_CORALOGIX_SERVICE_NAME",
#      "value": "send_emails"
#    }]
#  }]
#}

# bin_send_emails_trees
# Cron expression
#0 * ? * 1-5 *
# {
#  "containerOverrides": [{
#    "name": "meirim",
#    "command": [
#      "bin/send_emails_trees"
#    ],
#    "environment": [{
#      "name": "SERVER_CORALOGIX_SERVICE_NAME",
#      "value": "send_emails_trees"
#    }]
#  }]
#}

# mavat_backfill
# Fixed rate of
#7 day
# {
#  "containerOverrides": [{
#    "name": "meirim",
#    "command": [
#      "node",
#      "bin/complete_mavat_data.js"
#    ],
#    "environment": [{
#      "name": "SERVER_CORALOGIX_SERVICE_NAME",
#      "value": "mavat_backfill"
#    }]
#  }]
#}

# haifa-trees-target
# cron(25 9,19 ? * 1,2,3,4,5 *)
# https://github.com/hasadna/meirim-haifa-tree-felling-permits
# "image": "tomersha/haifa-tree-felling-permits:latest",
#       "environment": [
#        {
#          "name": "SCRAPINGBEE_API_KEY",
#          "value": "~vault:Projects/meirim/haifa-trees:SCRAPINGBEE_API_KEY~"
#        }
#      ],
#       "command": [
#        "--download",
#        "--upload",
#        "--s3-bucket",
#        "stg-service-tree-6b3da185",
#        "--s3-path",
#        "haifa",
#        "--proxy-country",
#        "il"
#      ],
{{ end }}
